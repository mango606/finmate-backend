plugins {
    id 'java'
    id 'war'
    id 'application'
    id 'idea'
    id 'jacoco'
}

group 'com.example'
version '1.0-SNAPSHOT'

repositories {
    mavenCentral()
}

ext {
    junitVersion = '5.10.2'
    springVersion = '5.3.37'
    springSecurityVersion = '5.8.13'
    lombokVersion = '1.18.30'
    jettyVersion = '9.4.53.v20231009'
}

sourceCompatibility = '17'
targetCompatibility = '17'

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}

dependencies {
    // ì„œë¸”ë¦¿ API
    implementation 'javax.servlet:javax.servlet-api:4.0.1'
    implementation 'javax.servlet.jsp:javax.servlet.jsp-api:2.3.3'
    implementation 'javax.servlet:jstl:1.2'

    // ë‚´ì¥ Jetty ì„œë²„ (ê°œë°œìš©)
    implementation "org.eclipse.jetty:jetty-server:${jettyVersion}"
    implementation "org.eclipse.jetty:jetty-servlet:${jettyVersion}"
    implementation "org.eclipse.jetty:jetty-webapp:${jettyVersion}"
    implementation "org.eclipse.jetty:jetty-annotations:${jettyVersion}"
    implementation "org.eclipse.jetty:jetty-plus:${jettyVersion}"

    // ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ (Spring Legacy)
    implementation("org.springframework:spring-context:${springVersion}") {
        exclude group: 'commons-logging', module: 'commons-logging'
    }
    implementation "org.springframework:spring-webmvc:${springVersion}"
    implementation "org.springframework:spring-web:${springVersion}"
    implementation "org.springframework:spring-core:${springVersion}"
    implementation "org.springframework:spring-beans:${springVersion}"
    implementation "org.springframework:spring-expression:${springVersion}"
    implementation "org.springframework:spring-aop:${springVersion}"

    // ì˜ì¡´ì„± ì£¼ì…
    implementation 'javax.inject:javax.inject:1'
    implementation 'javax.annotation:javax.annotation-api:1.3.2'

    // AOP
    implementation 'org.aspectj:aspectjrt:1.9.20'
    implementation 'org.aspectj:aspectjweaver:1.9.20'

    // SLF4J + Logback
    implementation 'org.slf4j:slf4j-api:2.0.7'
    implementation 'ch.qos.logback:logback-classic:1.4.8'
    implementation 'ch.qos.logback:logback-core:1.4.8'
    implementation 'org.slf4j:jcl-over-slf4j:2.0.7'
    implementation 'org.slf4j:jul-to-slf4j:2.0.7'

    // P6Spy ì œê±° - ë””ë²„ê¹…ì´ í•„ìš”í•  ë•Œ ì¶”ê°€
    // implementation 'p6spy:p6spy:3.9.1'

    // Swagger
    implementation 'io.springfox:springfox-boot-starter:3.0.0'

    // Lombok
    compileOnly "org.projectlombok:lombok:${lombokVersion}"
    annotationProcessor "org.projectlombok:lombok:${lombokVersion}"

    // Jackson - JSON ì²˜ë¦¬
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.15.2'
    implementation 'com.fasterxml.jackson.datatype:jackson-datatype-jsr310:2.15.2'
    implementation 'com.fasterxml.jackson.core:jackson-core:2.15.2'
    implementation 'com.fasterxml.jackson.core:jackson-annotations:2.15.2'

    // ë°ì´í„°ë² ì´ìŠ¤
    implementation 'com.mysql:mysql-connector-j:8.1.0'
    implementation 'com.zaxxer:HikariCP:5.0.1'

    // Spring JDBC & Transaction
    implementation "org.springframework:spring-tx:${springVersion}"
    implementation "org.springframework:spring-jdbc:${springVersion}"

    // MyBatis
    implementation 'org.mybatis:mybatis:3.5.13'
    implementation 'org.mybatis:mybatis-spring:2.1.1'

    // Spring Security
    implementation("org.springframework.security:spring-security-web:${springSecurityVersion}")
    implementation("org.springframework.security:spring-security-config:${springSecurityVersion}")
    implementation("org.springframework.security:spring-security-core:${springSecurityVersion}")
    implementation("org.springframework.security:spring-security-taglibs:${springSecurityVersion}")

    // JWT
    implementation("io.jsonwebtoken:jjwt-api:0.11.5")
    runtimeOnly("io.jsonwebtoken:jjwt-impl:0.11.5")
    runtimeOnly("io.jsonwebtoken:jjwt-jackson:0.11.5")

    // Validation
    implementation 'org.hibernate.validator:hibernate-validator:6.2.5.Final'
    implementation 'org.glassfish:javax.el:3.0.0'

    // íŒŒì¼ ì—…ë¡œë“œ
    implementation 'commons-fileupload:commons-fileupload:1.5'
    implementation 'commons-io:commons-io:2.11.0'

    // í…ŒìŠ¤íŠ¸ìš© H2 ë°ì´í„°ë² ì´ìŠ¤
    testImplementation 'com.h2database:h2:2.1.214'

    // í…ŒìŠ¤íŠ¸
    testImplementation "org.springframework:spring-test:${springVersion}"
    testCompileOnly "org.projectlombok:lombok:${lombokVersion}"
    testAnnotationProcessor "org.projectlombok:lombok:${lombokVersion}"

    testImplementation("org.junit.jupiter:junit-jupiter-api:${junitVersion}")
    testRuntimeOnly("org.junit.jupiter:junit-jupiter-engine:${junitVersion}")
    testImplementation('org.mockito:mockito-core:4.11.0')
    testImplementation('org.mockito:mockito-junit-jupiter:4.11.0')

    // Spring Test ê´€ë ¨
    testImplementation('org.springframework:spring-test:5.3.37')
    testImplementation('org.springframework.security:spring-security-test:5.8.13')

    // MockMvc ë° JSON í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì˜ì¡´ì„±
    testImplementation('org.hamcrest:hamcrest:2.2')
    testImplementation('org.hamcrest:hamcrest-library:2.2')
    testImplementation('com.jayway.jsonpath:json-path:2.8.0')
    testImplementation('com.jayway.jsonpath:json-path-assert:2.8.0')
}

// Application í”ŒëŸ¬ê·¸ì¸ ì„¤ì •
application {
    mainClass = 'com.example.finmate.JettyLauncher'
}

// WAR ë°°í¬ ì„¤ì •
war {
    archiveFileName = 'finmate-backend.war'
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE

    // ì›¹ ë¦¬ì†ŒìŠ¤ ë³µì‚¬
    from('src/main/webapp') {
        exclude 'WEB-INF/classes/**'
        exclude 'WEB-INF/lib/**'
    }
}

test {
    useJUnitPlatform()

    testLogging {
        events "passed", "skipped", "failed"
        exceptionFormat "full"
        showStandardStreams = false
        showStackTraces = true
    }

    jvmArgs = [
            '-Xmx1024m',
            '-Xms512m',
            '-XX:MetaspaceSize=256m',
            '-XX:MaxMetaspaceSize=512m',
            '-Dfile.encoding=UTF-8',
            '-Duser.timezone=Asia/Seoul',
            '-Djava.awt.headless=true'
    ]

    // í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •
    systemProperty 'spring.profiles.active', 'test'

    // ì„±ëŠ¥ ì„¤ì •
    maxParallelForks = 1
    forkEvery = 100

    // íƒ€ì„ì•„ì›ƒ ì„¤ì •
    timeout = Duration.ofMinutes(10)

    // ì‹¤íŒ¨ ì‹œ ê³„ì† ì§„í–‰
    failFast = false

    // ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€
    afterTest { descriptor, result ->
        logger.lifecycle("Test: $descriptor, Result: $result.resultType")
    }
}

// ì»´íŒŒì¼ ì˜µì…˜
compileJava {
    options.compilerArgs += ['-parameters']
    options.encoding = 'UTF-8'
}

compileTestJava {
    options.compilerArgs += ['-parameters']
    options.encoding = 'UTF-8'
}

task runServer(type: JavaExec) {
    group = 'application'
    description = 'FinMate ì„œë²„ ì‹¤í–‰'
    mainClass = 'com.example.finmate.JettyLauncher'
    classpath = sourceSets.main.runtimeClasspath

    // UTF-8 ì‹œìŠ¤í…œ í”„ë¡œí¼í‹° ê°•ì œ ì„¤ì •
    systemProperty 'file.encoding', 'UTF-8'
    systemProperty 'user.timezone', 'Asia/Seoul'
    systemProperty 'console.encoding', 'UTF-8'
    systemProperty 'java.awt.headless', 'true'
    systemProperty 'user.language', 'ko'
    systemProperty 'user.country', 'KR'
    systemProperty 'sun.jnu.encoding', 'UTF-8'

    jvmArgs = [
            '-Xmx1024m',
            '-Xms512m',
            '-Dfile.encoding=UTF-8',
            '-Dconsole.encoding=UTF-8',
            '-Duser.language=ko',
            '-Duser.country=KR',
            '-Dsun.jnu.encoding=UTF-8',
            '-Djava.awt.headless=true'
    ]

    doFirst {
        println "ğŸš€ FinMate ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
        println "ğŸ“ URL: http://localhost:8080"
        println "ğŸ‘¥ íšŒì› í˜ì´ì§€: http://localhost:8080/member.html"
        println "ğŸ“– API ë¬¸ì„œ: http://localhost:8080/swagger-ui/index.html"
    }
}

// í…ŒìŠ¤íŠ¸ ì—†ì´ ë¹Œë“œí•˜ëŠ” íƒœìŠ¤í¬
task buildNoTest {
    group = 'build'
    description = 'í…ŒìŠ¤íŠ¸ ì—†ì´ ë¹Œë“œ'
    dependsOn 'clean', 'compileJava', 'processResources', 'classes'
}

// í…ŒìŠ¤íŠ¸ ì—†ì´ ì„œë²„ ì‹¤í–‰
task runServerNoTest {
    group = 'application'
    description = 'í…ŒìŠ¤íŠ¸ ì—†ì´ ì„œë²„ ì‹¤í–‰'
    dependsOn 'buildNoTest'
    finalizedBy 'runServer'
}

// ì§ì ‘ ì‹¤í–‰ íƒœìŠ¤í¬ (ì˜ì¡´ì„± í¬í•¨)
task runJetty(type: JavaExec) {
    group = 'application'
    description = 'Jetty ì„œë²„ ì§ì ‘ ì‹¤í–‰'
    mainClass = 'com.example.finmate.JettyLauncher'
    classpath = sourceSets.main.runtimeClasspath + sourceSets.main.output
    systemProperty 'file.encoding', 'UTF-8'
    systemProperty 'user.timezone', 'Asia/Seoul'
    jvmArgs = ['-Xmx1024m', '-Xms512m']

    doFirst {
        println "ğŸš€ Jetty ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
        println "ğŸ“ URL: http://localhost:8080"
    }
}

// Fat JAR ìƒì„± (ëª¨ë“  ì˜ì¡´ì„± í¬í•¨)
task fatJar(type: Jar) {
    group = 'build'
    description = 'ëª¨ë“  ì˜ì¡´ì„±ì„ í¬í•¨í•œ ì‹¤í–‰ ê°€ëŠ¥í•œ JAR ìƒì„±'
    archiveFileName = 'finmate-server.jar'
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE

    manifest {
        attributes(
                'Main-Class': 'com.example.finmate.JettyLauncher',
                'Implementation-Title': 'FinMate Server',
                'Implementation-Version': project.version
        )
    }

    from {
        configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
    }

    with jar
}

// Fat JAR ì‹¤í–‰ íƒœìŠ¤í¬
task runFatJar(type: Exec) {
    group = 'application'
    description = 'Fat JARë¡œ ì„œë²„ ì‹¤í–‰'
    dependsOn fatJar

    commandLine 'java', '-jar', 'build/libs/finmate-server.jar'

    doFirst {
        println "ğŸš€ Fat JARë¡œ ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
    }
}

// í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì„¤ì •
tasks.register('testReport', TestReport) {
    group = 'reporting'
    description = 'í†µí•© í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ìƒì„±'
    destinationDirectory = file("$buildDir/reports/allTests")
    testResults.from(file("$buildDir/test-results/test"))
}