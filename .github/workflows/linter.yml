name: ğŸ” FinMate Code Quality & Linting

on:
  pull_request:
    branches: [ "main", "develop" ]
  push:
    branches: [ "main" ]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # ì „ì²´ ì½”ë“œë² ì´ìŠ¤ ë¦°íŒ…
  super-linter:
    runs-on: ubuntu-latest
    name: ğŸ” Super Linter

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          # PRì˜ ëª¨ë“  íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì™€ì•¼ ì •í™•í•œ ë¶„ì„ ê°€ëŠ¥
          fetch-depth: 0

      - name: ğŸ” Lint Code Base
        uses: github/super-linter@v5
        env:
          # ë³€ê²½ëœ íŒŒì¼ë§Œ ê²€ì‚¬í•˜ì—¬ ì†ë„ë¥¼ ë†’ì„
          VALIDATE_ALL_CODEBASE: false
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # Java ê´€ë ¨ ë¦°í„° ì„¤ì •
          VALIDATE_JAVA: true
          VALIDATE_GOOGLE_JAVA_FORMAT: true

          # Web ê´€ë ¨ íŒŒì¼ ê²€ì¦
          VALIDATE_HTML: true
          VALIDATE_CSS: true
          VALIDATE_JAVASCRIPT_ES: true
          VALIDATE_JSON: true
          VALIDATE_XML: true
          VALIDATE_YAML: true

          # ë¬¸ì„œ ê²€ì¦
          VALIDATE_MARKDOWN: true

          # Docker ê´€ë ¨
          VALIDATE_DOCKERFILE: true
          VALIDATE_DOCKERFILE_HADOLINT: true

          # ìŠ¤í¬ë¦½íŠ¸ ê²€ì¦
          VALIDATE_BASH: true

          # ë³´ì•ˆ ê´€ë ¨
          VALIDATE_GITHUB_ACTIONS: true

          # ì œì™¸í•  ë””ë ‰í† ë¦¬
          FILTER_REGEX_EXCLUDE: .*/(build|target|node_modules|\.gradle)/.*

  # Java ì „ìš© ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  java-quality:
    runs-on: ubuntu-latest
    name: â˜• Java Code Quality

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ”§ Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ“Š Run Checkstyle
        run: ./gradlew checkstyleMain checkstyleTest
        continue-on-error: true

      - name: ğŸ” Run SpotBugs
        run: ./gradlew spotbugsMain spotbugsTest
        continue-on-error: true

      - name: ğŸ“ˆ Run PMD
        run: ./gradlew pmdMain pmdTest
        continue-on-error: true

      - name: ğŸ“‹ Upload Checkstyle Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: build/reports/checkstyle/
          retention-days: 30

      - name: ğŸ“‹ Upload SpotBugs Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-report
          path: build/reports/spotbugs/
          retention-days: 30

      - name: ğŸ“‹ Upload PMD Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pmd-report
          path: build/reports/pmd/
          retention-days: 30

  # ì½”ë”© ìŠ¤íƒ€ì¼ ê²€ì‚¬
  code-style:
    runs-on: ubuntu-latest
    name: ğŸ¨ Code Style Check

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ¨ Check Google Java Format
        uses: axel-op/googlejavaformat-action@v3
        with:
          args: "--set-exit-if-changed --replace"
          skip-commit: true

      - name: ğŸ“ Check for formatting changes
        run: |
          if [[ `git status --porcelain` ]]; then
            echo "âŒ ì½”ë“œ í¬ë§·íŒ…ì´ Google Java Style Guideë¥¼ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."
            echo "ë³€ê²½ì´ í•„ìš”í•œ íŒŒì¼ë“¤:"
            git status --porcelain
            echo ""
            echo "ğŸ’¡ ë¡œì»¬ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ìë™ í¬ë§·íŒ…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:"
            echo "   ./gradlew googleJavaFormat"
            exit 1
          else
            echo "âœ… ëª¨ë“  Java íŒŒì¼ì´ Google Java Style Guideë¥¼ ë”°ë¦…ë‹ˆë‹¤."
          fi

  # ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
  security-linting:
    runs-on: ubuntu-latest
    name: ğŸ” Security Linting

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/java
            p/owasp-top-ten
            p/cwe-top-25
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: ğŸ” Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: java

      - name: â˜• Set up JDK 17 for CodeQL
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ”§ Setup Gradle for CodeQL
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ—ï¸ Build for CodeQL
        run: ./gradlew clean build -x test

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ì˜ì¡´ì„± ê²€ì‚¬
  dependency-check:
    runs-on: ubuntu-latest
    name: ğŸ“¦ Dependency Check

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ”§ Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ“¦ Check for vulnerable dependencies
        run: ./gradlew dependencyCheckAnalyze
        continue-on-error: true

      - name: ğŸ“‹ Upload Dependency Check Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: build/reports/dependency-check-report.html
          retention-days: 30

      - name: ğŸ”’ Check for license compatibility
        run: ./gradlew checkLicense
        continue-on-error: true

  # ë¬¸ì„œ í’ˆì§ˆ ê²€ì‚¬
  documentation-quality:
    runs-on: ubuntu-latest
    name: ğŸ“– Documentation Quality

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“– Lint Markdown files
        uses: articulate/actions-markdownlint@v1
        with:
          config: .markdownlint.json
          files: '**/*.md'
          ignore: 'node_modules'

      - name: ğŸ”— Check Markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'yes'
          config-file: '.markdown-link-check.json'

      - name: ğŸ“ Check spelling
        uses: streetsidesoftware/cspell-action@v6
        with:
          files: |
            **/*.md
            **/*.java
            **/*.yml
            **/*.yaml
            **/*.json
          incremental_files_only: false

  # ì¢…í•© ë¦¬í¬íŠ¸ ìƒì„±
  quality-report:
    runs-on: ubuntu-latest
    name: ğŸ“Š Quality Summary Report
    needs: [super-linter, java-quality, code-style, security-linting, dependency-check, documentation-quality]
    if: always()

    steps:
      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4

      - name: ğŸ“Š Generate Quality Report
        run: |
          echo "# ğŸ” FinMate ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼" > quality-report.md
          echo "" >> quality-report.md
          echo "## ğŸ“‹ ê²€ì‚¬ ê²°ê³¼ ìš”ì•½" >> quality-report.md
          echo "" >> quality-report.md
          
          # ê° ê²€ì‚¬ì˜ ê²°ê³¼ ìƒíƒœ
          echo "| ê²€ì‚¬ í•­ëª© | ìƒíƒœ | ë¹„ê³  |" >> quality-report.md
          echo "|----------|------|------|" >> quality-report.md
          
          if [ "${{ needs.super-linter.result }}" == "success" ]; then
            echo "| ğŸ” ì „ì²´ ë¦°íŒ… | âœ… í†µê³¼ | ëª¨ë“  íŒŒì¼ì´ ê¸°ì¤€ì„ ì¶©ì¡±í•©ë‹ˆë‹¤ |" >> quality-report.md
          else
            echo "| ğŸ” ì „ì²´ ë¦°íŒ… | âŒ ì‹¤íŒ¨ | ë¦°íŒ… ê·œì¹™ ìœ„ë°˜ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤ |" >> quality-report.md
          fi
          
          if [ "${{ needs.java-quality.result }}" == "success" ]; then
            echo "| â˜• Java í’ˆì§ˆ | âœ… í†µê³¼ | Checkstyle, SpotBugs, PMD ê²€ì‚¬ í†µê³¼ |" >> quality-report.md
          else
            echo "| â˜• Java í’ˆì§ˆ | âš ï¸ ê²½ê³  | ì¼ë¶€ í’ˆì§ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤ |" >> quality-report.md
          fi
          
          if [ "${{ needs.code-style.result }}" == "success" ]; then
            echo "| ğŸ¨ ì½”ë“œ ìŠ¤íƒ€ì¼ | âœ… í†µê³¼ | Google Java Style Guide ì¤€ìˆ˜ |" >> quality-report.md
          else
            echo "| ğŸ¨ ì½”ë“œ ìŠ¤íƒ€ì¼ | âŒ ì‹¤íŒ¨ | ì½”ë“œ í¬ë§·íŒ…ì´ í•„ìš”í•©ë‹ˆë‹¤ |" >> quality-report.md
          fi
          
          if [ "${{ needs.security-linting.result }}" == "success" ]; then
            echo "| ğŸ” ë³´ì•ˆ ê²€ì‚¬ | âœ… í†µê³¼ | ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ |" >> quality-report.md
          else
            echo "| ğŸ” ë³´ì•ˆ ê²€ì‚¬ | âš ï¸ ê²€í†  | ë³´ì•ˆ ì´ìŠˆ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤ |" >> quality-report.md
          fi
          
          if [ "${{ needs.dependency-check.result }}" == "success" ]; then
            echo "| ğŸ“¦ ì˜ì¡´ì„± ê²€ì‚¬ | âœ… í†µê³¼ | ì•ˆì „í•œ ì˜ì¡´ì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© |" >> quality-report.md
          else
            echo "| ğŸ“¦ ì˜ì¡´ì„± ê²€ì‚¬ | âš ï¸ ê²½ê³  | ì˜ì¡´ì„± ì·¨ì•½ì  ê²€í†  ê¶Œì¥ |" >> quality-report.md
          fi
          
          if [ "${{ needs.documentation-quality.result }}" == "success" ]; then
            echo "| ğŸ“– ë¬¸ì„œ í’ˆì§ˆ | âœ… í†µê³¼ | ë¬¸ì„œê°€ í’ˆì§ˆ ê¸°ì¤€ì„ ì¶©ì¡±í•©ë‹ˆë‹¤ |" >> quality-report.md
          else
            echo "| ğŸ“– ë¬¸ì„œ í’ˆì§ˆ | âš ï¸ ê°œì„  | ë¬¸ì„œ í’ˆì§ˆ ê°œì„ ì´ ê¶Œì¥ë©ë‹ˆë‹¤ |" >> quality-report.md
          fi
          
          echo "" >> quality-report.md
          echo "## ğŸ¯ ê°œì„  ê¶Œì¥ì‚¬í•­" >> quality-report.md
          echo "" >> quality-report.md
          echo "- ğŸ“Š ìƒì„¸í•œ ê²€ì‚¬ ê²°ê³¼ëŠ” ê° ì•„í‹°íŒ©íŠ¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”" >> quality-report.md
          echo "- ğŸ”§ ì½”ë“œ ìŠ¤íƒ€ì¼ ì´ìŠˆëŠ” \`./gradlew googleJavaFormat\`ìœ¼ë¡œ ìë™ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤" >> quality-report.md
          echo "- ğŸ” ë³´ì•ˆ ì´ìŠˆëŠ” ê°œë°œíŒ€ê³¼ ê²€í†  í›„ ì ì ˆí•œ ì¡°ì¹˜ë¥¼ ì·¨í•´ì£¼ì„¸ìš”" >> quality-report.md
          echo "- ğŸ“¦ ì˜ì¡´ì„± ì·¨ì•½ì ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—…ë°ì´íŠ¸ë¥¼ ê²€í† í•´ì£¼ì„¸ìš”" >> quality-report.md
          echo "" >> quality-report.md
          echo "---" >> quality-report.md
          echo "ğŸŒŸ **FinMate ì œí…Œí¬ ì„œë¹„ìŠ¤** - ë†’ì€ ì½”ë“œ í’ˆì§ˆë¡œ ì•ˆì •ì ì¸ ê¸ˆìœµ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤ ğŸ¦" >> quality-report.md

      - name: ğŸ“‹ Upload Quality Report
        uses: actions/upload-artifact@v4
        with:
          name: quality-summary-report
          path: quality-report.md
          retention-days: 90

      - name: ğŸ’¬ Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = './quality-report.md';
            
            if (fs.existsSync(path)) {
              const report = fs.readFileSync(path, 'utf8');
            
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report + '\n\nğŸ¤– *ì´ ë¦¬í¬íŠ¸ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
              });
            }