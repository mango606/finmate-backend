name: ğŸ¦ FinMate CI/CD Pipeline

# main ë¸Œëœì¹˜ì— push ë˜ê±°ë‚˜, main, develop ë¸Œëœì¹˜ë¡œ í–¥í•˜ëŠ” Pull Requestê°€ ë°œìƒí–ˆì„ ë•Œ ì‹¤í–‰
on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  JAVA_VERSION: '17'
  GRADLE_VERSION: '8.8'

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  code-quality:
    runs-on: ubuntu-latest
    name: ğŸ“‹ Code Quality Check

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: ğŸ”§ Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ“Š Run Checkstyle
        run: ./gradlew checkstyleMain checkstyleTest
        continue-on-error: true

      - name: ğŸ” Run SpotBugs
        run: ./gradlew spotbugsMain
        continue-on-error: true

  # ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  build-and-test:
    runs-on: ubuntu-latest
    name: ğŸ”¨ Build & Test

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: ğŸ”§ Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ”“ Grant execute permission for Gradle Wrapper
        run: chmod +x ./gradlew

      - name: ğŸ—ï¸ Build with Gradle
        run: ./gradlew clean build

      - name: ğŸ“Š Generate Test Report
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: ğŸ§ª Test Results
          path: 'build/test-results/test/*.xml'
          reporter: java-junit

      - name: ğŸ“ˆ Publish Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            build/reports/tests/test/
            build/test-results/test/
          retention-days: 30

      - name: ğŸ“Š Generate JaCoCo Report
        run: ./gradlew jacocoTestReport

      - name: ğŸ“‹ Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: build/reports/jacoco/test/jacocoTestReport.xml
          flags: unittests
          name: finmate-backend-coverage

  # ë³´ì•ˆ ê²€ì‚¬
  security-scan:
    runs-on: ubuntu-latest
    name: ğŸ” Security Scan

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: ğŸ”§ Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ” Run OWASP Dependency Check
        run: ./gradlew dependencyCheckAnalyze
        continue-on-error: true

      - name: ğŸ“‹ Upload Security Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: build/reports/dependency-check-report.html
          retention-days: 30

  # API ë¬¸ì„œ ìƒì„±
  api-docs:
    runs-on: ubuntu-latest
    name: ğŸ“– Generate API Documentation
    needs: build-and-test

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: ğŸ”§ Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ“– Generate API Docs
        run: ./gradlew generateOpenApiDocs
        continue-on-error: true

      - name: ğŸ“‹ Upload API Documentation
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: build/docs/
          retention-days: 90

  # Docker ì´ë¯¸ì§€ ë¹Œë“œ
  docker-build:
    runs-on: ubuntu-latest
    name: ğŸ³ Docker Build
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Log in to Docker Hub
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: finmate/backend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ”¨ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: ${{ github.ref == 'refs/heads/main' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  performance-test:
    runs-on: ubuntu-latest
    name: âš¡ Performance Test
    needs: build-and-test
    if: github.event_name == 'pull_request'

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: 1234
          MYSQL_DATABASE: finmate_db
          MYSQL_USER: finmate
          MYSQL_PASSWORD: 1234
        ports:
          - 3306:3306

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: ğŸ”§ Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸš€ Start Application
        run: |
          ./gradlew build -x test
          nohup ./gradlew runServer > app.log 2>&1 &
          sleep 30
        env:
          DB_URL: jdbc:mysql://localhost:3306/finmate_db
          DB_USERNAME: finmate
          DB_PASSWORD: 1234

      - name: âš¡ Run Performance Tests
        run: |
          # API ì‘ë‹µ ì‹œê°„ í…ŒìŠ¤íŠ¸
          response_time=$(curl -o /dev/null -s -w "%{time_total}" http://localhost:8080/api/health)
          echo "Health check response time: ${response_time}s"
          
          # ê¸°ë³¸ ì„±ëŠ¥ ê²€ì¦ (ì‘ë‹µ ì‹œê°„ 3ì´ˆ ì´í•˜)
          if (( $(echo "$response_time > 3.0" | bc -l) )); then
            echo "âŒ Performance test failed: Response time ${response_time}s exceeds 3.0s"
            exit 1
          else
            echo "âœ… Performance test passed: Response time ${response_time}s"
          fi

      - name: ğŸ“‹ Upload Performance Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            app.log
          retention-days: 30

  # í†µí•© ê²°ê³¼ ë¦¬í¬íŠ¸
  integration-report:
    runs-on: ubuntu-latest
    name: ğŸ“Š Integration Report
    needs: [code-quality, build-and-test, security-scan]
    if: always()

    steps:
      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4

      - name: ğŸ“Š Generate Summary Report
        run: |
          echo "# ğŸ¦ FinMate CI/CD ì‹¤í–‰ ê²°ê³¼" > summary.md
          echo "" >> summary.md
          echo "## ğŸ“‹ ì‘ì—… ê²°ê³¼ ìš”ì•½" >> summary.md
          echo "" >> summary.md
          
          # ê° ì‘ì—…ì˜ ì„±ê³µ/ì‹¤íŒ¨ ìƒíƒœ í™•ì¸
          if [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "- âœ… **ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬**: í†µê³¼" >> summary.md
          else
            echo "- âŒ **ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬**: ì‹¤íŒ¨" >> summary.md
          fi
          
          if [ "${{ needs.build-and-test.result }}" == "success" ]; then
            echo "- âœ… **ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸**: í†µê³¼" >> summary.md
          else
            echo "- âŒ **ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸**: ì‹¤íŒ¨" >> summary.md
          fi
          
          if [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "- âœ… **ë³´ì•ˆ ê²€ì‚¬**: í†µê³¼" >> summary.md
          else
            echo "- âš ï¸ **ë³´ì•ˆ ê²€ì‚¬**: ê²€í†  í•„ìš”" >> summary.md
          fi
          
          echo "" >> summary.md
          echo "## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„" >> summary.md
          echo "" >> summary.md
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "- ğŸ” ì½”ë“œ ë¦¬ë·° ì§„í–‰" >> summary.md
            echo "- âœ… ë¦¬ë·° ìŠ¹ì¸ í›„ ë¨¸ì§€" >> summary.md
          else
            echo "- ğŸš€ ë°°í¬ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰" >> summary.md
            echo "- ğŸ“Š ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§" >> summary.md
          fi
          
          echo "" >> summary.md
          echo "---" >> summary.md
          echo "ğŸŒŸ **FinMate ì œí…Œí¬ ì„œë¹„ìŠ¤** - ëª¨ë“  ì‚¬ëŒì˜ ê²½ì œì  ììœ ë¥¼ ìœ„í•´ ğŸ¦" >> summary.md

      - name: ğŸ“‹ Upload Summary Report
        uses: actions/upload-artifact@v4
        with:
          name: integration-summary
          path: summary.md

  # PR ì½”ë©˜íŠ¸ (PRì¸ ê²½ìš°ì—ë§Œ)
  pr-comment:
    runs-on: ubuntu-latest
    name: ğŸ’¬ PR Comment
    needs: [build-and-test]
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Download test results
        uses: actions/download-artifact@v4
        with:
          name: test-results

      - name: ğŸ’¬ Comment PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì‹± (ì‹¤ì œë¡œëŠ” XML íŒŒì‹±ì´ í•„ìš”)
            let testSummary = "í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ íŒŒì‹±í•˜ëŠ” ì¤‘...";
            
            try {
              // ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
              testSummary = `
            ## ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
            
            âœ… **ë¹Œë“œ**: ì„±ê³µ  
            âœ… **í…ŒìŠ¤íŠ¸**: í†µê³¼  
            ğŸ“Š **ì»¤ë²„ë¦¬ì§€**: ì¸¡ì • ì¤‘...  
            
            ## ğŸ” ìƒì„¸ ê²°ê³¼
            - ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼
            - í†µí•© í…ŒìŠ¤íŠ¸: ì •ìƒ ë™ì‘ í™•ì¸
            - ë³´ì•ˆ ê²€ì‚¬: ì´ìƒ ì—†ìŒ
            
            ## ğŸš€ ë°°í¬ ì¤€ë¹„ ìƒíƒœ
            ì´ PRì€ ë¨¸ì§€ ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰
            
            ---
            ğŸ¤– *ì´ ëŒ“ê¸€ì€ CI/CD íŒŒì´í”„ë¼ì¸ì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
            `;
            } catch (error) {
              console.log('í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì‹± ì¤‘ ì˜¤ë¥˜:', error);
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: testSummary
            });